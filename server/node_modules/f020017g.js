/*eslint no-console: 0, "quotes": [0, "single"], module: 0, globals:[0, "obj"]*/
/*eslint no-unused-vars: ["error", { "args": "none" }]*/
/**"f020017g": {
            "title": "Строка поиска клиентов",
            "info": "Мобильный клиент получает строку поиска клиентов. Может содержать данные которых нет на мобильном клиенте"
        }, */
'use strict';
exports.fun = function (client, obj, db) {
	return new Promise(function (resolve, reject) {
		if (!(client.auth)) {
			resolve({ "result": false });
			return;
		}
		var q;
		if (obj.fullsync === true) {
			q = `SELECT
					dp.dp_id,
					concat_ws(' ', dp.dp_name, dp.dp_info, ca.ca_name,
					ca.ca_info, ca.ca_inn, adr.adr_str,
					(adr.adr_json->'nominatim'->'display_name') )as value
				FROM trade.delivery_points dp
				LEFT JOIN trade.links_countragent_delivery_point lcdp ON dp.dp_id = lcdp.dp_id
				LEFT JOIN trade.countragents ca ON ca.ca_id=lcdp.ca_id
				LEFT JOIN trade.address adr ON (adr.any_id=dp.dp_id) AND (adr.adrt_id=3)`;
		} else {
			q = `SELECT
					dp.dp_id,
					concat_ws(' ', dp.dp_name, dp.dp_info, ca.ca_name,
					ca.ca_info, ca.ca_inn, adr.adr_str,
					(adr.adr_json->'nominatim'->'display_name') )as value
				FROM trade.delivery_points dp
				LEFT JOIN trade.links_countragent_delivery_point lcdp ON dp.dp_id = lcdp.dp_id
				LEFT JOIN trade.countragents ca ON ca.ca_id=lcdp.ca_id
				LEFT JOIN trade.address adr ON (adr.any_id=dp.dp_id) AND (adr.adrt_id=3)
				JOIN (
					SELECT MAX(st2.st_stime) AS st_stime
					FROM trade.sync_token st2
					WHERE st2.t_id = $1 AND st2.st_table = 'f020017g' AND st2.st_result = TRUE
				) AS st ON (st.st_stime <= adr.adr_mtime)
						OR (st.st_stime <= lcdp.lcp_mtime)
						OR (st.st_stime <= ca.ca_mtime)
						OR (st.st_stime <= dp.dp_mtime);`;
		}
		db.query(q, [client.t_id]).then(
			(value) => {
				db.one(`INSERT INTO trade.sync_token (t_id, st_table, st_stime, st_etime, st_result) VALUES
  						($1,'f020017g',now(),null, FALSE ) RETURNING trade.sync_token.st_id`, [client.t_id]).then(
					(st) => {
						var sync = +st.st_id;
						resolve({ "data": value, sync });
					});
			});
	});
};