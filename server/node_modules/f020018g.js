/*eslint no-console: 0, "quotes": [0, "single"], module: 0, globals:[0, "obj"]*/
/*eslint no-unused-vars: ["error", { "args": "none" }]*/
/*"f020018g": {
            "title": "Новости",
            "info": "Мобильный клиент получает новости по каналу синхронизации"
        } */
'use strict';
exports.fun = function (client, obj, db) {
	return new Promise(function (resolve, reject) {
		if (!(client.idToken)) {
			resolve({ "result": false });
			return;
		}
		var q;
		
		if (obj.fullsync === true) {
			q = `SELECT n.*
				FROM trade.news n
				JOIN trade.links_news ln ON (n.n_id = ln.n_id) AND (ln.at_id = 4)
				JOIN trade.token t ON (ln.any_id = t.u_id)
				WHERE (t.t_id = $1);`;
		} else {
			q = `SELECT n.*
				FROM trade.news n
				JOIN trade.links_news ln ON (n.n_id = ln.n_id) AND (ln.at_id = 4)
				JOIN trade.token t ON (ln.any_id = t.u_id)
				JOIN ( 
					SELECT MAX(st2.st_stime) AS st_stime FROM trade.sync_token st2 
					WHERE st2.t_id = $1 AND st2.st_table = 'f020018g' AND st2.st_result = TRUE 
				) as st ON ( st.st_stime <= n.n_date )
				WHERE (t.t_id = $1);`;
		}
		if (obj.full === true) {
			q = `SELECT n.*
				FROM trade.news n;`;
		}
		db.query(q, [client.t_id]).then(
			(value) => {
				db.one(`INSERT INTO trade.sync_token (t_id, st_table, st_stime, st_etime, st_result) VALUES
  						($1,'f020018g',now(),null, FALSE ) RETURNING trade.sync_token.st_id`, [client.t_id]).then(
					(st_id) => {
						var sync = +st_id.st_id;
						resolve({ "data": value, sync });
					}
					);

			});

		//console.log(obj, client);


	});
};