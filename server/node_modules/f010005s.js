/*eslint no-console: 0, "quotes": [0, "single"], module: 0, globals:[0, "obj"]*/
/*eslint no-unused-vars: ["error", { "args": "none" }]*/
/**
 		"f010005s": {
			"title": "Пользователи",
			"info": "Добавление новых пользователей/редактирование пользователей",
			"example body": {
				"users": [
					{
						"u_id": 1,
						"u_login": "gofman",
						"u_pass": "1",
						"p_id": 324,
						"u_permission": null,
						"u_mtime": 1498314763
					},
					{
						"u_login": "new",
						"u_pass": "11",
						"p_id": 326,
						"u_permission": null,
						"u_mtime": 1498314763
					}
				]
			},
			"example return": {
				"result": true
			}
        }, */
'use strict';
exports.fun = function (client, obj, db) {
	return new Promise(function (resolve, reject) {
		if (!(client.auth)) {
			resolve({ "result": false, "sync": obj.sync });
			return;
		}
		var q = "";
		var ins = [];
		var upd = [];
		var val = [];
		obj.data.forEach(function (el) {
			if (el.u_id) {
				upd.push(el);

			} else ins.push(el);
		}, this);
		if (ins.length > 0) {
			q += `INSERT INTO trade.users (u_login, u_pass, p_id, u_permission, u_mtime)
					VALUES `;
			for (let i = 0; i < ins.length; i++) {
				if (i) q += ',';
				val.push(ins[i].u_login);
				val.push(ins[i].u_pass);
				val.push(ins[i].p_id);
				val.push(ins[i].u_permission);
				q += `($${i * 4 + 1}, $${i * 4 + 2}, $${i * 4 + 3}, $${i * 4 + 4}, now())`;

			}
			q += ` RETURNING trade.users.u_id;
			`;
		}
		if (upd.length > 0) {
			q += `UPDATE trade.users SET `;
			for (let i = 0; i < upd.length; i++) {
				if (upd[i].u_pass) {
					val.push(upd[i].u_pass);
					q += ` u_pass = $${val.length},`;
				}
				val.push(upd[i].u_id);
				q += ` u_mtime      = now()
				WHERE u_id = $${val.length} RETURNING trade.users.u_id;`;
			}
			/*q += `SELECT
					u_id,
					u_login,
					u_pass,
					p_id,
					u_permission,
					extract(EPOCH FROM u_mtime) :: INTEGER AS u_mtime
				FROM (VALUES `;
			for (let i = 0; i < upd.length; i++) {
				if (i) q += ',';
				q += `(${upd[i].u_id})`;
				//val.push(upd[i].u_id);
			}
			q += `) AS s(id)  JOIN trade.users u ON (s.id = u.u_id);`;*/
		}
		console.log(q, val);
		//console.log(obj, client);
		db.query(q, val).then(
			(value) => {
				resolve({ "data": value, "sync": obj.sync });
			});
	});
};