/*eslint no-console: 0, "quotes": [0, "single"], module: 0, globals:[0, "obj"]*/
/*eslint no-unused-vars: ["error", { "args": "none" }]*/
/*"f020023g": {
    "title": "Связи людей",
    "info": "Получить связи людей с должностями и организаиями (клиентами и т.д.)",
    "example body": {},
    "example return": {}
},*/
'use strict';
exports.fun = function (client, obj, db) {
	return new Promise(function (resolve, reject) {
		if (!(client.idToken)) {
			resolve({ "result": false });
			return;
		}
		var q;
		if (obj.fullsync === true) {
			q = `SELECT
                pl_id, 
                plt_id, 
                pp_id, 
                p_id, 
                any_id, 
                pl_date_b, 
                pl_date_e, 
                pl_active, 
                extract(EPOCH FROM pl_mtime) :: INTEGER AS pl_mtime
            FROM trade.people_link pl;`;
		} else {
			q = `SELECT
                pl_id, 
                plt_id, 
                pp_id, 
                p_id, 
                any_id, 
                pl_date_b, 
                pl_date_e, 
                pl_active, 
                extract(EPOCH FROM pl_mtime) :: INTEGER AS pl_mtime
            FROM trade.people_link pl
			JOIN (
				SELECT MAX(st2.st_stime) AS st_stime
				FROM trade.sync_token st2
				WHERE st2.t_id = $1 AND st2.st_table = 'f020023g' AND st2.st_result = TRUE
			) AS st ON (st.st_stime <= pl.pl_mtime);`;
		}
		db.query(q, [client.t_id]).then(
			(value) => {
				db.one(`INSERT INTO trade.sync_token (t_id, st_table, st_stime, st_etime, st_result) VALUES
  						($1,'f020023g',now(),null, FALSE ) RETURNING trade.sync_token.st_id`, [client.t_id]).then(
					(st) => {
						var sync = +st.st_id;
						resolve({ "data": value, sync });
					});
			});
	});
};
