/*eslint no-console: 0, "quotes": [0, "single"], module: 0, globals:[0, "obj"]*/
/*eslint no-unused-vars: ["error", { "args": "none" }]*/
/*"f010007s": {
			"title": "Уведомления",
			"info": "Отправка уведомлений, на мобильные устройства",
			"example body": {
				"tokens": [
					7
				],
				"data": {
					"d": [
						{
							"head": "f020018g",
							"body": {
								"fullsync": true
							}
						}
					],
					"n": {
						"t": "Заголовок уведомления",
						"b": "Тело уведомления. Здесь содержится текста немного больше."
					},
					"b": {
						"h": "f020018g",
						"d": [
							{
								"n_id": 10,
								"n_date": "2017-06-24T12:43:59.784Z",
								"n_title": "ААААА!!! Новость",
								"n_text": "Вышел вкусный продукт (очень вкусный). Бодренько продаем!",
								"n_data": null,
								"n_type": 1
							}
						]
					}
				}
			},
			"example return": {
				"result": true
			}
		}, */
'use strict';
var admin = require("firebase-admin");
var serviceAccount = {
	"type": "service_account",
	"project_id": "trade-d15ce",
	"private_key_id": "aff170ad72b731024ebfb058cce255e20c2da940",
	"private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC1F8MR4Gm2S6lQ\nWZlywmFXxTRpqDjgANSSdeVWX78NsdwQFXPg6hruN42WQlY4Shh5Dl7SYzY+xEGI\nlL12zbfgVF0fd4ntA0a7gpO7auiZhZcCDM44mVPtNar3HaK/U4Gwa/q96VSWXXF8\nQbp/QNnOI46d8LCEKlJAAvlEH72Wr2GSAz0Me3/FwhHq8CiqXs/l8z0z6oK3c+qf\nsBwpuzaJRRhMBZnHsozjooSFm1MN1JNnqorVANJ0OPtANbJrgjHDFzPZGyDa04s0\nHxVxgoCNJxrOKmRu3tvfbU2RvsqU9BMKr169GZdZw65IpPEfe6kYpO5KHdQrF+mJ\nsm+nJk0TAgMBAAECggEAAqPnjK2sbON6gvjjc1hhKfHumzHALofkkYQVhWZc9zqm\nHjfp2hgfr2Rw9IVgE28FH1K10DRxGIYs/GxKvN4v9Z3VQ72u7Z00HUzAkaVz4bUg\nZ/++y/V0U0uKhBLTCh4SEHvqinVJ7e1L18dvjCZqZoZ/ME9Pi4XAcD162+LolTdQ\nEGILrym8V1tDXuFfkpZ9yJRc7c9LSh5+FLpYdLZaYQRosWigZRU8RXuVSe95zemx\nFvWc1wW9+4xcf4axbIYAo8bLBG2qGuXuuDkoFfAn0BoikOT8DNVQ3kJQK5xsyyFh\ndeUnEUpCnvoAWnE7zSJZk012ihgmAhaViKUyso+YCQKBgQDwTUQc6JBt7fdSMGQX\nKc00oSrKqpn7RAjSuDs4lCH9sElyjt9o9chBFKvurDOI4aKBLjuzg1jZ0p7cL7HF\nj+awZjKol5zXz1OJIWyVdzUg8/kCF4uLmzVM9JCxpPy0zan9DMY4i2Px9wqJwtZv\nBFimMTd1D4HNGfPR7OwQ+2XeywKBgQDA7E2CJOCenI2aDBBvSRd34kg+g1xKhY++\nwsVZuQP2+TDGEofmruqaYqCktsXELJk4fywuoCKtq0oABAF115u6werlN+7wE+31\ncF6OsCgy65SIKUcd/+fL2Yg7fjbsxYBQ3GPeI2v9vJQUuvdNF79JuopRSwlQAy8t\np5BKpCv52QKBgCh6256DDtF15NPTkwjT4d2byLmbQ5UwQMw+fLtrOM6jg7volXn4\n7WMJOG1cVNIaMGXSg/wZhD4tXNV6s1e0hgfxL1d3MtSn+EqBduk2y5xhfPD9RmSe\nILx19mn2gRt0Cc62+C1OTefU1dGfIMBS2xwj7lOp6RPD627RmnLB5sdBAoGATRcf\n8b1itH7CZqgjeRSv+AvH6pL7Mhwk0Ilr6upvlyUERGHrRFbpEEARCUCvzjA0GctX\nkFoVAWjM7SysmLZLWFlcz7OGGxEbqVP5tPLXXWGdvLsh2+8CZQbL1VoeAIb7O1SV\n45Ir+Px9/7qmT3wJyCBuXQWq9voOxCONGQZ5PCECgYEA1HMJxNGvtcxWdQchLYDI\nDPp1wskXRq/j4hiMQTdUA2qQMSMsxiDUpdgc7mco8o3GNWpVD8CoyRmSlcr17Ntb\nML3wacEbkpU7T7ElPnjqfqETP8BCWPO7UsbWf3cnEMC9MLgzBCUgpcoKZNeize+c\nD7OPY9nNQcpvhF9JW3AWjX4=\n-----END PRIVATE KEY-----\n",
	"client_email": "firebase-adminsdk-6gdkk@trade-d15ce.iam.gserviceaccount.com",
	"client_id": "110441742778342137960",
	"auth_uri": "https://accounts.google.com/o/oauth2/auth",
	"token_uri": "https://accounts.google.com/o/oauth2/token",
	"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
	"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-6gdkk%40trade-d15ce.iam.gserviceaccount.com"
};


exports.fun = function (client, obj, db) {
	return new Promise(function (resolve, reject) {
		if (!(client.auth)) {
			resolve({ "result": false, "sync": obj.sync });
			return;
		}
		var q = `SELECT t.t_fcm FROM( VALUES `;
		for (var i = 0; i < obj.tokens.length; i++) {
			if (i) q += ',';
			q += '($' + (i + 1) + ')';
		}
		q += ` ) AS d(a) JOIN trade.token AS t ON d.a=t.t_id`;


		console.log(q, obj.tokens);
		db.query(q, obj.tokens).then(

			(value) => {
				var app = admin.initializeApp({
					credential: admin.credential.cert(serviceAccount),
					databaseURL: "https://trade-d15ce.firebaseio.com"
				});
				var registrationTokens = [];
				for (var i = 0; i < value.length; i++) {
					registrationTokens.push(value[i].t_fcm);
				}

				var payload = {
					data: {
						d: JSON.stringify(obj.data),
					}
				};

				var options = {
					priority: "high",
					timeToLive: 60 * 60 * 24
				};
				if (registrationTokens.length > 0) {
					admin.messaging().sendToDevice(registrationTokens, payload, options).then(function (response) {
						console.log(response);
						resolve({ "result": true });
						app.delete();
					}).catch(function (error) {
						console.log(error);
						resolve({ "result": false });
						app.delete();
					});
				}
			});
	});
};